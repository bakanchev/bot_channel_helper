Что это за бот?

Передо мной стояла задача написать бота по проекту, который имеет хотя бы 5 методов, желательно как можно более разнородных.

Решил не делать что-то банальное из разряда расписаний/статистики, а сделать бота, которым я действительно хотел бы пользоваться сам.

**Идея**

При ведении своего собственного телеграм-канала автор часто задумывается о том, как увеличить количество подписичиков своего канала, как его раскрутить. Наблюдая за рекламами в крупных каналах, я заметил, что при нажатии на ссылку вступления в канал, появляются подобные окна:

![Окно при нажатии на ссылку канала](https://i.ibb.co/tDkqdxn/IMG-1645.jpg)

И после нажатия на эту ссылку, тебя сразу принимают в канал. Очевидно, что это делается автоматически, не вручную. То есть ботом.

Это и стало отправной точкой в теме выбора бота. А что именно будет в функционале бота, читайте дальше.

К слову, в процессе я обнаружил еще одну очень интересную вещь: бот может законно написать человеку первым, даже если сам человек никогда не начинал писать боту. Да, это звучит удивительно, но это реально так, пример:

![Бот пишет человеку первым](https://i.ibb.co/CnbSf9N/IMG-1630.png)

**Какие задачи были поставлены**

+ сделать бота, который мог бы принимать заявки в закрытую группу автоматически
+ сразу после принятия в канал, бот присылает приветственное сообщение и предлагает некоторый подарок на выбор
+ человек может забрать его по кнопке (здесь просто заглушки сделаны, как задел на будущие доработки)
+ конечно, нужно обязательно сохранять всех таких людей в БД, чтобы потом можно было реализовывать рассылки по базе данных: рекламные или другого рода (сохранение в БД сделано, рассылки нет)
+ нужно чтобы были функции супер-администратора (владельца закрытого канала) и чтобы он мог назначить/удалять администраторов (админов), а администраторы могли устанавливать офферы на вступление (менять описания)
+ чтобы стать супер-администратором, нужно прислать боту секретную команду (чтобы ее узнать, надо написать разработчику бота)
+ супер-администратор может установить в боте два канала: основной и резервный. В момент установки каналов происходит диалог с сохранением текущих состояний (FSM, конечные автоматы), притом при выборе каналов, бот автоматически добавляется в эти каналы администратором с нужными правами.

Изначально у меня была идея с тем, чтобы можно было менять каналы местами: открывать один канал, а при этом закрывать другой. Зачем: иногда хочется, чтобы канал был открытым, когда не происходят рекламные акции, любой человек может найти канал по поиску, а если происходит реклама, тогда мы закрываем канал и появляются заявки на вступление, которые обрабатывает бот. Но при переводе канала в закрытый, мы теряем публичную ссылку, поэтому ее полезно "застолбить" на резервном канале. И вот тут у меня случилась проблема: когда я читал документацию API телеграм, я видел, что устанавливать url каналов, менять их можно, но не увидел, что этот функционал доступен только пользователям, а не ботам. Соответственно в aiogram такого функционала нет, поэтому от этого функционала я отказался, но установка двух каналов при этом все равно доступна.

**Как протестировать функционал бота**
Создайте два тестовых канала: один основной, второй резервный. Основной канал вам не потребуется по причинам выше, поэтому работа пойдет с резервным каналом. В резервном канале создайте ссылку на вступление в него с опцией "Заявки на вступление".

Далее напишите разработчику бота с запросом на супердадмина (получите секретную команду), введите ее в боте. Бот скажет вам, что теперь вы супер-админ, далее введите команду /start (здесь по-хорошему бот сам должен был это предложить, я увы не успел эти мелочи пофиксить, потому что времени было совсем мало), вам будут доступны различные команды.

Нажмите кнопку `Настроить каналы` и пройдите по диалогу (FSM) с установкой каналов. Теперь в обоих каналах у вас автоматически этот бот будет добавлен в качестве администратора с необходимыми правами.

Далее нажмите кнопку `Настроить оффер`, установите оффер на вступление в тот резервный канал, который вы показали. Чтобы понять, что такое оффер, это та надпись, которую будет видеть обычный пользователь при вступлении в ваш канал:

![Оффер при вступлении в закрытый канал](https://i.ibb.co/vwvhMQL/offer.jpg)

Проверьте, что описание резервного канала поменялось. (Здесь я заметил небольшие баги, что бот может прислать ошибку или ничего не сказать, но при этом описание меняется. Изменения в код после дедлайна не вносил, но скорее всего это можно оперативно поправить)

Теперь вам потребуется еще один другой аккаунт (например, друга), чтобы назначить его администратором. По кнопке добавьте администратора (здесь тоже FSM сделан). Скиньте ссылку на бота этому аккаунту, при нажатии кнопки `/start` у него должна появиться единственная кнопка `Настроить оффер` (поскольку он не является супер-администратором). Пусть он попробует установить другой оффер. Проверьте, что описание канала поменялось. (Этот функционал нужен например для того, чтобы маркетолог мог оперативно менять офферы на вступление в канал в зависимости от текущей рекламной акции)

Теперь вам потребуется третий аккаунт в качестве обычного юзера. Перешлите ему ссылку на вступление в резервный канал (ту самую, которую вы сделали с опцией заявок на вступление). При вступлении по этой ссылке, бот должен прислать юзеру первым(!) приветственное сообщение с выбором полезности (здесь сделаны самые простые заглушки, файлы не присылаются по факту).

Теперь попробуйте добавить администратора, но выберите уже того, кто им является. Появится ошибка.
Теперь попробуйте удалить администратора, но выберите того, кто им не является. Появится ошибка.
Теперь попробуйте удалить администратора, но выберите того, кто им является. Появится сообщение о том, что админ удален. Проверьте на втором аккаунте, что при нажатии `/start` кнопка `Настроить оффер` пропала, теперь он рядовой пользователь и ему доступны кнопки с получением полезностей.

Вроде бы это все, но возможно что-то я забыл указать, что было реализовано еще.

При создании бота были сделаны различные фильтры для разделения по уровням пользователей: `superadmin, admin, follower`. То есть обычным пользователям не видна админка, а админам не видна суперадминка. 

Были реализованы конечные автоматы (FSM) с ветвлением диалогов, чтобы корректно проходила установка каналов, установка офферов, добавление/удаление админов.

**Как можно развить бота дальше**
+ сделать логгирование ошибок не принтами, а например подключить Sentry, чтобы отлавливать все ошибки в реал-тайм
+ доделать функционал администрирования: прислать суперадмину всех текущих админов, администраторы могут кроме офферов включать/выключать опцию добавления в каналы, например
+ со стороны пользователей бот должен уметь делать рассылки по базе, можно расширить поле user: например, спрашивать возраст пользователя, в каком он классе/студент/преподаватель, затем разделять рассылки по таким тегам. В целом со стороны обычного пользователя бота расширить, добавить тоже FSM интересные.
+ БД sqlite3 заменить на более сильную при увеличении нагрузки на бота

